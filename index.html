<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contract & e-Signature System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- NEW: Signature Pad Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- NEW: PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f5f5f5;
            min-height: 100vh;
        }
        
        #clientSignatureCanvas, #mySignatureCanvas {
            touch-action: none; 
        }

        /* ACTIVE TAB STYLING - Updated to match reference blue */
        .tab-active-bg {
            background-color: #2563eb; /* Tailwind blue-600 */
            color: white;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .tab-btn {
             border-radius: 0.375rem; /* rounded-md */
             transition: all 0.2s ease-in-out;
        }
        
        .tab-btn:hover:not(.tab-active) {
            background-color: #f3f4f6; /* gray-100 */
        }

        /* CONTENT PANEL */
        .content-panel {
            display: none;
        }
        .content-panel.active {
            display: block;
        }

        /* CONTRACT TEXT STYLES */
        .agreement-text p {
            margin-bottom: 1rem;
            line-height: 1.6;
            color: #333;
            font-size: 0.95rem;
            font-weight: 400; 
        }
        .agreement-text ul {
            list-style: disc;
            margin-left: 2rem;
            margin-bottom: 1rem;
        }
        
        /* Dynamic text styling */
        .dynamic-text-span {
            display: inline-block;
            line-height: 1.2;
            min-width: 20px;
            text-align: center;
            color: #9ca3af; /* gray-400 */
        }
        
        .dynamic-text-span.has-value {
            color: inherit;
        }

        .section-title {
            font-size: 1rem; 
            font-weight: 500; 
            margin-top: 2rem; 
            margin-bottom: 0.75rem;
            color: #1a1a1a;
            text-transform: capitalize; 
        }
        
        /* INVOICE specific styles */
        .invoice-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        .invoice-table th, .invoice-table td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }
        .invoice-table th {
            font-weight: 600;
            color: #4b5563;
            background-color: #f9fafb;
        }
        .invoice-table tr:last-child td {
            border-bottom: none;
        }
        .totals-row td {
            border-top: 1px solid #d1d5db !important;
            font-weight: 600;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: none;
                margin: 0;
            }
            .main-document-card {
                border: none !important;
                box-shadow: none !important;
            }
            .agreement-text .dynamic-text-span,
            .agreement-text .dynamic-text-span.has-value {
                border: none !important;
                padding: 0 !important;
                margin: 0 !important;
                display: inline !important; 
                color: #333 !important; 
            }
            .document-footer {
                min-height: 100px;
            }
        }
        
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        /* Lock down fields in client mode */
        .client-mode .agreement-main-inputs input,
        .client-mode .agreement-main-inputs select,
        .client-mode .agreement-main-inputs textarea {
            background-color: #f5f5f5 !important;
            cursor: not-allowed;
            pointer-events: none;
        }
        /* Lock down fields for Service Provider when isLocked is true */
        .locked-mode .agreement-main-inputs input,
        .locked-mode .agreement-main-inputs select,
        .locked-mode .agreement-main-inputs textarea {
            background-color: #f5f5f5 !important;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased">

<div id="app" class="pb-16 pt-6">
    
    <main class="max-w-4xl mx-auto p-2 sm:p-4 lg:p-8">
        
        <!-- NEW: Unified Top Layout (Tabs Left, Cloud Right) -->
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 no-print gap-4">
            
            <!-- Left: Segmented Control Tab Switcher -->
            <div class="bg-white p-1 rounded-lg border border-gray-200 shadow-sm inline-flex items-center">
                <button id="tab-agreement" class="tab-btn px-4 py-2 text-sm font-semibold flex items-center gap-2 tab-active tab-active-bg" onclick="switchTab('agreement', this)">
                    <i class="fas fa-file-contract"></i> Contract
                </button>
                <button id="tab-invoice" class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500 flex items-center gap-2" onclick="switchTab('invoice', this)">
                    <i class="fas fa-file-invoice-dollar"></i> Invoice
                </button>
            </div>

            <!-- Right: Cloud Status and Reset Indicator -->
            <div class="flex items-center gap-3">
                 <!-- Reset Button (NEW) -->
                <button onclick="resetApp()" class="text-gray-500 hover:text-red-600 transition-colors p-2 rounded-full hover:bg-white" title="Reset Application / Start New Contract">
                    <i class="fas fa-sync-alt"></i>
                </button>
                
                <!-- Cloud Status Indicator -->
                <div id="cloud-indicator-box" class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm transition-all duration-300">
                    <!-- Dot -->
                    <div id="cloud-status-dot" class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.6)]"></div>
                    <!-- Text -->
                    <span id="cloud-status-text" class="text-xs font-semibold text-gray-500 uppercase tracking-wide">Cloud Disabled</span>
                </div>
            </div>
        </div>
        
        <!-- Status message -->
        <div id="loading-indicator" class="bg-yellow-100 text-yellow-800 p-3 rounded-lg font-medium mb-4 text-center hidden">
            <i class="fas fa-spinner fa-spin mr-2"></i> Initializing App...
        </div>
        <div id="status-message" class="mt-4 text-center text-sm font-medium hidden p-2 rounded-md"></div>


        <!-- AGREEMENT INPUTS BLOCK -->
        <div id="agreement-inputs-block" class="no-print bg-white p-4 sm:p-6 border border-gray-400 mb-4 sm:mb-6 rounded-md shadow-sm">
            <h3 class="font-medium text-gray-700 text-base mb-3" id="input-block-title">Contract Details</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 sm:gap-4 agreement-main-inputs">
                <div class="col-span-1">
                    <label for="my_name_main" class="block font-medium text-gray-700 text-xs sm:text-sm">My Name (Service Provider)</label>
                    <input type="text" id="my_name_main" data-model="my_name" oninput="handleInputChange(this)" placeholder="e.g., Mukul Uprikar" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>

                <div class="col-span-1">
                    <label for="client_name_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Client Name</label>
                    <input type="text" id="client_name_main" data-model="client_name" oninput="handleInputChange(this)" placeholder="e.g., ABC Marketing Ltd." class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>
                
                <!-- NEW: Client Email Input -->
                <div class="col-span-1">
                    <label for="client_email_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Client Email (Required for sharing)</label>
                    <input type="email" id="client_email_main" data-model="client_email" oninput="handleInputChange(this)" placeholder="client@example.com" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>
                
                <div class="col-span-1">
                    <label for="project_title_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Project Title</label>
                    <input type="text" id="project_title_main" data-model="project_title" oninput="handleInputChange(this)" placeholder="e.g., 'Product Launch Ad'" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>

                <!-- 1. Contract Date Input -->
                <div class="col-span-1">
                    <label for="agreement_date_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Contract Date</label>
                    <input type="date" id="agreement_date_main" data-model="agreement_date" oninput="handleInputChange(this)" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>
                
                <!-- 2. Currency Select -->
                <div class="col-span-1">
                    <label for="currency_select" class="block font-medium text-gray-700 text-xs sm:text-sm">Currency</label>
                    <select id="currency_select" data-model="currency" onchange="handleCurrencyChange(this)" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm bg-white">
                        <option value="INR">₹ Indian Rupee (INR)</option>
                        <option value="USD">$ US Dollar (USD)</option>
                        <option value="EUR">€ Euro (EUR)</option>
                        <option value="GBP">£ British Pound (GBP)</option>
                        <option value="AUD">A$ Australian Dollar (AUD)</option>
                        <option value="CAD">C$ Canadian Dollar (CAD)</option>
                        <option value="SGD">S$ Singapore Dollar (SGD)</option>
                        <option value="JPY">¥ Japanese Yen (JPY)</option>
                        <option value="AED">د.إ UAE Dirham (AED)</option>
                    </select>
                </div>
                
                <!-- 3. Total Fee -->
                <div class="col-span-1">
                    <label for="total_fee_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Total Fee</label>
                    <input type="number" id="total_fee_main" data-model="total_fee" oninput="handleInputChange(this)" placeholder="e.g., 50000" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>
                
                <!-- 4. Deposit % -->
                <div class="col-span-1">
                    <label for="deposit_required_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Deposit % (0-100)</label>
                    <input type="number" id="deposit_required_main" data-model="deposit_required" oninput="handleInputChange(this)" placeholder="e.g., 30" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm">
                </div>
                
                <!-- 5. Document Type Switch -->
                <div class="col-span-1">
                    <label for="document_type_select" class="block font-medium text-gray-700 text-xs sm:text-sm">Document Type</label>
                    <select id="document_type_select" data-model="document_type" onchange="handleDocumentTypeChange(this)" class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm bg-white">
                        <option value="Contract">Contract (अनुबंध)</option>
                        <option value="Agreement">Agreement (समझौता)</option>
                    </select>
                </div>

                <div class="col-span-3">
                    <label for="project_scope_main" class="block font-medium text-gray-700 text-xs sm:text-sm">Project Scope Summary</label>
                    <textarea id="project_scope_main" data-model="project_scope" oninput="handleInputChange(this)" rows="3" placeholder="Briefly describe the deliverables, duration, and key outcomes." class="mt-1 block w-full border border-gray-300 p-2 rounded-md shadow-sm text-sm"></textarea>
                </div>
            </div>
        </div>

        <!-- Document Card Container -->
        <div class="bg-white main-document-card border border-gray-400">
            <div class="p-4 sm:p-6 md:p-10" id="agreement-document-area">
                
                <!-- AGREEMENT MAKER PAGE -->
                <div id="agreement" class="content-panel active">
                    <h2 class="text-xl sm:text-2xl font-medium text-gray-800 mb-4 sm:mb-6 text-center" id="document_main_title">CONTRACT</h2>
                    
                    <!-- AGREEMENT TEXT -->
                    <div class="agreement-text"><br>
                        
                        <p>This Freelance Service <span id="doc_type_p1" class="dynamic-text-span has-value">Contract</span> ("<span id="doc_type_p1_short" class="dynamic-text-span has-value">Contract</span>") is entered into on <span id="agreement_date_display" class="dynamic-text-span"></span> by and between <span id="my_name_display_text" class="dynamic-text-span"></span> (the "Service Provider"), and <span id="client_name_display_text" class="dynamic-text-span"></span> (the "Client").</p>

                        <div class="section-title">1. Project scope and deliverables</div>
                        <p>The Service Provider agrees to perform professional video editing services for the Client in relation to the project titled <span id="project_title_display_text" class="dynamic-text-span"></span>. The scope of work is defined as: <span id="project_scope_display_text" class="dynamic-text-span"></span>.</p>
                        <p>Any requests for services outside of this agreed scope must be submitted in writing and may incur additional charges and timeline extensions.</p>

                        <div class="section-title">2. Fees and payment terms</div>
                        <p>The Total Fee for the services rendered under this <span id="doc_type_p2_lower" class="dynamic-text-span has-value">contract</span> is <span id="currency_symbol_display" class="dynamic-text-span"></span><span id="total_fee_display" class="dynamic-text-span"></span> (the "Total Fee").</p>
                        <p>The Client shall pay an initial, non-refundable deposit equal to <span id="deposit_required_display" class="dynamic-text-span"></span> % of the Total Fee upon signing this <span id="doc_type_p2" class="dynamic-text-span has-value">Contract</span> to secure the booking. The remaining balance is due immediately upon Client approval of the final draft and before the release of final, unwatermarked files.</p>
                        <p>Payments overdue by seven (7) days will be subject to a late payment fee of 5% per week on the outstanding balance.</p>

                        <div class="section-title">3. Revisions and delivery</div>
                        <p>The Total Fee includes two (2) rounds of minor revisions at no additional cost. Major revisions or revisions requested after the second round will be billed hourly.</p>
                        <p>Final deliverables will be transferred via a secure cloud service (e.g., Google Drive) upon confirmation of full payment.</p>
                        
                        <div class="section-title">4. Intellectual property (IP)</div>
                        <p>Upon receipt of full and final payment, the Service Provider grants the Client an exclusive, perpetual, worldwide license to use the final video deliverable(s). The Service Provider retains copyright ownership of all raw footage, project files, and underlying templates unless a separate fee for source files is paid.</p>
                        <p>The Client warrants that they have the legal right to use all assets (music, footage, logos) provided to the Service Provider and agrees to indemnify the Service Provider against any claims related to those assets.</p>

                        <div class="section-title">5. Termination and cancellation</div>
                        <p>If the Client terminates this <span id="doc_type_p5" class="dynamic-text-span has-value">Contract</span> after work has commenced, the initial deposit is forfeited. If termination occurs after the first draft is delivered, a Kill Fee equal to 50% of the Total Fee is immediately due.</p>
                        <p>If the Client fails to communicate or provide necessary assets for a period of thirty (30) days, the project is deemed abandoned, and the full remaining balance becomes immediately payable.</p>

                        <div class="section-title">6. Governing law</div>
                        <p>This <span id="doc_type_p6" class="dynamic-text-span has-value">Contract</span> shall be governed by the laws of Maharashtra, India, and any disputes shall be resolved in the appropriate courts in Maharashtra.</p>
                        
                        <!-- SIGNATURE AREA -->
                        <div class="document-footer mt-8 sm:mt-12 pt-4 sm:pt-6 border-t border-gray-400 grid grid-cols-1 sm:grid-cols-2 gap-6 sm:gap-10 text-sm">
                            <!-- Service Provider Signature (Self-signed) -->
                            <div>
                                <h3 class="text-center font-medium mb-2">Service Provider Signature</h3>
                                <div id="my-signature-area" class="relative">
                                    <canvas id="mySignatureCanvas" class="border border-gray-700 w-full h-32 rounded-md bg-gray-50"></canvas>
                                    <button onclick="clearMySignature()" class="absolute top-1 right-1 bg-red-100 text-red-600 p-1 rounded-full text-xs hover:bg-red-200 transition-colors no-print" title="Clear Signature">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <img id="mySignatureImage" style="display:none;" class="w-full h-32 object-contain rounded-md" />
                                </div>
                                <p class="text-center font-medium mt-1"><span id="my_name_display_signature" class="dynamic-text-span"></span> (Service Provider)</p>
                            </div>

                            <!-- Client Signature Area -->
                            <div>
                                <h3 class="text-center font-medium mb-2 text-red-600">CLIENT: Sign Here</h3>
                                <div id="client-signature-area" class="relative">
                                    <canvas id="clientSignatureCanvas" class="border border-gray-700 w-full h-32 rounded-md bg-gray-50"></canvas>
                                    <button onclick="clearClientSignature()" class="absolute top-1 right-1 bg-red-100 text-red-600 p-1 rounded-full text-xs hover:bg-red-200 transition-colors no-print" title="Clear Signature">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <img id="clientSignatureImage" style="display:none;" class="w-full h-32 object-contain rounded-md" />
                                </div>
                                <p class="text-center font-medium mt-1"><span id="client_name_display_signature" class="dynamic-text-span"></span> (Client)</p>
                            </div>
                        </div>

                        <!-- ACTIONS BUTTONS -->
                        <div id="agreement-actions" class="no-print mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                            
                            <!-- Main Service Provider Action: Sign and Share -->
                            <button id="main-action-btn" onclick="serviceProviderAction()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-lg transition-colors duration-150 shadow-md">
                                <i id="main-action-icon" class="fas fa-file-signature mr-2"></i> Lock and Share
                            </button>
                            
                            <!-- Client Action (Hidden unless in client mode) -->
                            <button id="client-sign-btn" onclick="clientSignAgreement()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-lg transition-colors duration-150 shadow-md hidden">
                                <i class="fas fa-pencil-alt mr-2"></i> Client: Final Sign-off
                            </button>

                            <!-- Print Action (Always visible) -->
                            <button id="print-btn" onclick="printDocument()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-lg transition-colors duration-150 shadow-md">
                                <i class="fas fa-print mr-2"></i> Print/Download PDF
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- INVOICE MAKER PAGE -->
                <div id="invoice" class="content-panel">
                    <h2 class="text-xl sm:text-2xl font-medium text-gray-800 mb-6 sm:mb-8 text-center">INVOICE</h2>

                    <!-- My Info & Client Info -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 mb-6 sm:mb-8">
                        <div>
                            <h3 class="text-xs sm:text-sm font-medium uppercase text-gray-500 mb-2">Service Provider</h3>
                            <input type="text" id="my_name" oninput="updateInvoice('my_name', this.value)" class="invoice-input mb-1 font-medium">
                            <input type="text" id="my_address" oninput="updateInvoice('my_address', this.value)" class="invoice-input mb-1">
                            <input type="email" id="my_email" oninput="updateInvoice('my_email', this.value)" class="invoice-input">
                        </div>
                        <div class="text-left sm:text-right">
                            <div class="flex justify-start sm:justify-end items-center mb-2">
                                <span class="font-medium text-gray-700 mr-2 w-1/3 sm:w-auto">INVOICE #</span>
                                <input type="text" id="invoice_id" oninput="updateInvoice('invoice_id', this.value)" class="invoice-input w-2/3 sm:w-1/2">
                            </div>
                            <div class="flex justify-start sm:justify-end items-center">
                                <span class="font-medium text-gray-700 mr-2 w-1/3 sm:w-auto">Date:</span>
                                <input type="date" id="invoice_date" oninput="updateInvoice('invoice_date', this.value)" class="invoice-input w-2/3 sm:w-1/2">
                            </div>
                        </div>
                    </div>

                    <hr class="mb-6 sm:mb-8 border-gray-300">

                    <!-- Client Info -->
                    <div class="mb-8 sm:mb-10">
                        <h3 class="text-xs sm:text-sm font-medium uppercase text-gray-500 mb-2">Bill To</h3>
                        <input type="text" id="client_invoice_name" data-model="client_name" oninput="handleInputChange(this); updateInvoice('client_invoice_name', this.value)" class="invoice-input mb-1 font-medium">
                        <input type="text" id="client_invoice_address" oninput="updateInvoice('client_invoice_address', this.value)" class="invoice-input mb-1" placeholder="Client Address">
                        <input type="email" id="client_invoice_email" oninput="updateInvoice('client_invoice_email', this.value)" class="invoice-input" placeholder="Client Email">
                    </div>

                    <!-- Line Items Table -->
                    <div class="overflow-x-auto mb-6">
                        <table class="w-full text-xs sm:text-sm invoice-table border border-gray-200 rounded-lg overflow-hidden min-w-[500px]">
                            <thead>
                                <tr>
                                    <th class="w-1/2">Description</th>
                                    <th class="w-1/6 text-center">Qty / Hrs</th>
                                    <th class="w-1/6 text-right">Rate</th>
                                    <th class="w-1/6 text-right">Amount</th>
                                    <th class="w-8 no-print"></th>
                                </tr>
                            </thead>
                            <tbody id="line-items-body">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Add Row Button -->
                    <button onclick="addItemRow()" class="no-print bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-2 px-4 rounded-md text-sm transition-colors duration-150">
                        <i class="fas fa-plus mr-1"></i> Add Line Item
                    </button>
                    
                    <!-- Totals and Summary -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 sm:gap-8 mt-6">
                        <div class="col-span-1">
                            <!-- Notes/Terms -->
                            <h3 class="text-xs sm:text-sm font-medium uppercase text-gray-500 mb-2">Payment Terms</h3>
                            <textarea id="payment_notes" oninput="updateInvoice('payment_notes', this.value)" rows="4" class="invoice-input resize-none"></textarea>
                        </div>
                        <div class="col-span-1 flex flex-col items-end">
                            <table class="w-full max-w-xs text-xs sm:text-sm">
                                <tr>
                                    <td class="text-right py-2">Subtotal:</td>
                                    <td class="text-right py-2 font-mono" id="subtotal_display"></td>
                                </tr>
                                <tr class="no-print">
                                    <td class="text-right py-2">Tax Rate (%):</td>
                                    <td class="text-right py-2">
                                        <input type="number" id="tax_rate" oninput="calculateTotals()" class="invoice-input w-16 sm:w-20 text-right inline-block" value="0">
                                    </td>
                                </tr>
                                <tr>
                                    <td class="text-right py-2">Tax Amount (<span id="tax_rate_display">0%</span>):</td>
                                    <td class="text-right py-2 font-mono" id="tax_amount_display"></td>
                                </tr>
                                <tr class="totals-row">
                                    <td class="text-right py-2 text-sm sm:text-base">TOTAL DUE:</td>
                                    <td class="text-right py-2 text-sm sm:text-base font-medium text-blue-800 font-mono" id="total_due_display"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Print Button -->
                    <div class="no-print mt-8 flex justify-center">
                        <button onclick="printDocument()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-lg transition-colors duration-150 shadow-md">
                            <i class="fas fa-print mr-2"></i> Print/Download PDF
                        </button>
                    </div>

                </div>

            </div>
        </div>
    </main>

    <!-- NEW: Email Share Modal -->
    <div id="email-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Share Contract for Signature</h3>
            <p class="mb-4 text-gray-600">Please confirm the client's email address to send the secure signing link.</p>
            <div class="relative mb-4">
                <label for="client_email_share" class="block font-medium text-gray-700 text-sm mb-1">Client Email</label>
                <!-- NOTE: client_email_main is synced to this on button click -->
                <input type="email" id="client_email_share" oninput="validateEmail(this.value)" placeholder="client@example.com" class="w-full p-3 border border-indigo-300 rounded-md text-sm">
                <p id="email-error" class="text-red-500 text-xs mt-1 hidden">Please enter a valid email address.</p>
            </div>
            
            <p class="text-xs text-gray-500 italic mb-4">
                <i class="fas fa-info-circle text-indigo-500 mr-1"></i> The contract link will be securely shared with this email.
            </p>
            <div class="flex space-x-3">
                <button onclick="closeModal('email-modal')" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded-md hover:bg-gray-400 transition-colors font-medium">Cancel</button>
                <button id="send-email-btn" onclick="sendEmailOrShowLink()" class="flex-1 bg-indigo-600 text-white py-2 rounded-md hover:bg-indigo-700 transition-colors font-medium" disabled>
                    <i class="fas fa-share-alt mr-2"></i> Lock & Share
                </button>
            </div>
        </div>
    </div>

    <!-- UPDATED: Simple Link Modal (Original share-modal) -->
    <div id="share-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-xl font-semibold mb-4 text-gray-800">Contract Link Generated</h3>
            <p id="share-modal-text" class="mb-4 text-gray-600">You can manually copy and send this unique, secure link to your client:</p>
            <div class="relative mb-4">
                <input type="text" id="share-link-input" readonly class="w-full p-3 border border-indigo-300 rounded-md bg-gray-100 text-sm font-mono text-indigo-700">
                <button onclick="copyShareLink()" class="absolute right-0 top-0 h-full px-3 bg-indigo-500 text-white rounded-r-md hover:bg-indigo-600 transition-colors">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <p class="text-xs text-gray-500 italic mb-4">
                <i class="fas fa-info-circle text-indigo-500 mr-1"></i> When the client signs, your document will update automatically.
            </p>
            <button onclick="closeModal('share-modal')" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition-colors">Close</button>
        </div>
    </div>
    
    <!-- NEW: Error Modal -->
    <div id="error-modal" class="modal">
        <div class="modal-content border-t-4 border-red-600">
            <h3 class="text-xl font-semibold mb-3 text-red-700">
                <i class="fas fa-exclamation-triangle mr-2"></i> Action Required
            </h3>
            <p id="error-modal-text" class="mb-5 text-gray-700 font-medium">
                [Error Message Placeholder]
            </p>
            <button onclick="closeModal('error-modal')" class="w-full bg-red-600 text-white py-2 rounded-md hover:bg-red-700 transition-colors">
                Got It
            </button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // setLogLevel('Debug'); 

    // --- FIREBASE GLOBALS ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    const isConfigValid = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.apiKey.length > 0;

    let app, db, auth, userId = null;
    let agreementId = new URLSearchParams(window.location.search).get('agreementId');
    let isClientMode = !!agreementId;

    // --- SIGNATURE GLOBALS ---
    let mySignaturePad, clientSignaturePad;
    
    // --- AGREEMENT DATA & STATE ---
    const agreementData = {
        my_name: "Service Provider Name",
        client_name: "Client Name",
        // NEW: Client Email
        client_email: "", 
        project_title: "Project Title",
        project_scope: "Briefly describe the deliverables.",
        total_fee: 50000,
        deposit_required: 30,
        currency: "INR",
        agreement_date: new Date().toISOString().substring(0, 10),
        document_type: "Contract", 
        // Cloud State
        status: 'Draft', // 'Draft', 'SignedByMe', 'SignedByClient'
        isLocked: false, 
        mySignatureData: null,
        clientSignatureData: null,
        signedByUserId: null 
    };

    const currencyMap = {
        'INR': { symbol: '₹', locale: 'en-IN', code: 'INR' },
        'USD': { symbol: '$', locale: 'en-US', code: 'USD' },
        'EUR': { symbol: '€', locale: 'de-DE', code: 'EUR' },
        'GBP': { symbol: '£', locale: 'en-GB', code: 'GBP' },
        'AUD': { symbol: 'A$', locale: 'en-AU', code: 'AUD' },
        'CAD': { symbol: 'C$', locale: 'en-CA', code: 'CAD' },
        'SGD': { symbol: 'S$', locale: 'en-SG', code: 'SGD' },
        'JPY': { symbol: '¥', locale: 'ja-JP', code: 'JPY' },
        'AED': { symbol: 'د.إ', locale: 'ar-AE', code: 'AED' }
    };
    
    // UPDATED: Added #client_email_main
    const agreementInputSelectors = [
        '#my_name_main', '#client_name_main', '#client_email_main', '#project_title_main', '#total_fee_main', '#deposit_required_main', '#project_scope_main',
        '#currency_select', '#agreement_date_main', '#document_type_select'
    ];
    
    // --- INVOICE DATA ---
    const invoiceData = {
        my_name: agreementData.my_name,
        my_address: "Pune, Maharashtra, India",
        my_email: "myemail@example.com",
        invoice_id: "INV-001",
        invoice_date: new Date().toISOString().substring(0, 10),
        client_invoice_name: agreementData.client_name,
        client_invoice_address: "",
        client_invoice_email: agreementData.client_email, // Link to agreementData
        payment_notes: "30% deposit already paid. Remaining 70% due upon delivery.",
        items: [
            { description: "Video Editing - Final Cut", qty: 10, rate: 5000, amount: 50000 },
        ]
    };
    
    // --- FIREBASE CORE FUNCTIONS ---

    function updateCloudIndicator(isActive) {
        const dot = document.getElementById('cloud-status-dot');
        const text = document.getElementById('cloud-status-text');
        
        if (isActive) {
            dot.classList.remove('bg-red-500', 'shadow-[0_0_8px_rgba(239,68,68,0.6)]');
            dot.classList.add('bg-green-500', 'shadow-[0_0_10px_#22c55e]', 'animate-pulse');
            text.textContent = 'Cloud Active';
            text.classList.remove('text-gray-500');
            text.classList.add('text-green-600');
        } else {
            dot.classList.remove('bg-green-500', 'shadow-[0_0_10px_#22c55e]', 'animate-pulse');
            dot.classList.add('bg-red-500', 'shadow-[0_0_8px_rgba(239,68,68,0.6)]');
            text.textContent = 'Cloud Disabled';
            text.classList.remove('text-green-600');
            text.classList.add('text-gray-500');
        }
    }

    async function initFirebase() {
        if (!isConfigValid) {
            updateStatus('Cloud features are temporarily disabled. Firebase configuration not fully loaded.', 'bg-red-100 text-red-800', true);
            updateCloudIndicator(false); 
            
            if (!isClientMode) {
                agreementId = `AGR-LOCAL-${Date.now()}`;
            }
            initializeInputs();
            updateAgreementContent();
            updateUIFromData();
            return;
        }

        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }

            await new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        agreementData.signedByUserId = userId;
                    } else {
                        userId = 'anonymous'; 
                    }
                    unsubscribe();
                    resolve();
                });
            });
            
            if (isClientMode) {
                document.getElementById('app').classList.add('client-mode');
                document.getElementById('input-block-title').textContent = 'Contract Details (Locked for Signing)';
                await loadAgreement(agreementId);
            } else {
                agreementId = `AGR-${Date.now()}`;
                initializeInputs();
                updateAgreementContent();
                await saveAgreementDraft(); 
            }
            
            startRealtimeListener();
            updateStatus('Cloud Connection Ready.', 'bg-green-100 text-green-800', true);
            updateCloudIndicator(true);

        } catch (error) {
            console.error("Firebase Initialization Error:", error);
            updateStatus(`Error: Failed to connect to cloud. ${error.message}`, 'bg-red-100 text-red-800', true);
            updateCloudIndicator(false); 
        }
    }

    function getAgreementDocRef(id) {
        return doc(db, `/artifacts/${appId}/public/data/agreements`, id);
    }
    
    window.updateStatus = function(message, classes, isPermanent = false) {
        const statusDiv = document.getElementById('status-message');
        const loadingDiv = document.getElementById('loading-indicator');
        const errorModal = document.getElementById('error-modal');
        const errorModalText = document.getElementById('error-modal-text');
        
        loadingDiv.classList.add('hidden');
        
        if (message.startsWith('ERROR:')) {
            statusDiv.classList.add('hidden'); 
            errorModalText.textContent = message.replace('ERROR: ', '');
            errorModal.classList.add('open');
            console.error(`[APP ERROR] ${message.replace('ERROR: ', '')}`);
            return; 
        }
        
        errorModal.classList.remove('open'); 
        console.log(`[APP STATUS] ${message}`);
        statusDiv.classList.add('hidden');
    }

    async function saveAgreementDraft() {
        if (!isConfigValid || !db) {
            updateStatus('Local draft saved. Cloud sync is disabled.', 'bg-yellow-100 text-yellow-800');
            return;
        }

        const dataToSave = { 
            ...agreementData,
            timestamp: new Date().toISOString(),
            mySignatureData: agreementData.mySignatureData || null,
            clientSignatureData: agreementData.clientSignatureData || null
        };
        
        try {
            await setDoc(getAgreementDocRef(agreementId), dataToSave, { merge: true });
            if (!isClientMode) {
                updateStatus('Draft saved successfully to the cloud.', 'bg-blue-100 text-blue-800');
            }
        } catch (error) {
            console.error("Error saving contract:", error);
            updateStatus('ERROR: Error saving draft. Check console.', 'bg-red-100 text-red-800');
        }
    }
    
    function startRealtimeListener() {
        if (!isConfigValid || !db) return;

        onSnapshot(getAgreementDocRef(agreementId), (docSnapshot) => {
            if (docSnapshot.exists()) {
                const cloudData = docSnapshot.data();
                Object.assign(agreementData, cloudData);

                updateUIFromData();
                updateAgreementContent();

                if (agreementData.status === 'SignedByClient' && !isClientMode) {
                    updateStatus('SUCCESS! Client signature received in real-time. Document is COMPLETE!', 'bg-green-100 text-green-800', true);
                } else if (agreementData.status === 'SignedByMe' && isClientMode) {
                    updateStatus('Document loaded and signed by Service Provider. Please sign below.', 'bg-yellow-100 text-yellow-800', true);
                }
            } else {
                if (isClientMode) {
                    updateStatus('ERROR: Shared Contract not found.', 'bg-red-100 text-red-800', true);
                }
            }
        }, (error) => {
            console.error("Realtime listener failed:", error);
            updateStatus('ERROR: Realtime updates interrupted. Check connection.', 'bg-red-100 text-red-800', true);
            updateCloudIndicator(false); 
        });
    }

    async function loadAgreement(id) {
        if (!isConfigValid || !db) return;
        try {
            const docSnap = await getDoc(getAgreementDocRef(id));
            if (docSnap.exists()) {
                Object.assign(agreementData, docSnap.data());
                initializeInputs(); 
            } else {
                throw new Error("Document does not exist");
            }
        } catch (error) {
            console.error("Error loading contract:", error);
            updateStatus(`ERROR: Could not load contract ${id}.`, 'bg-red-100 text-red-800', true);
        }
    }

    // --- UI UPDATE HANDLERS ---
    function initializeInputs() {
         document.querySelectorAll(agreementInputSelectors.join(', ')).forEach(input => {
            const key = input.getAttribute('data-model');
            let value = agreementData[key];
            if (input.type === 'date') { 
                value = value || new Date().toISOString().substring(0, 10);
            } else if (input.type !== 'number') { 
                value = value || ""; 
            }
            input.value = value;
        });
        document.getElementById('currency_select').value = agreementData.currency;
        document.getElementById('document_type_select').value = agreementData.document_type; 
    }

    function updateUIFromData() {
        // --- Signature Displays ---
        
        const mySigImg = document.getElementById('mySignatureImage');
        const mySigCanvas = document.getElementById('mySignatureCanvas');

        // Service Provider Signature
        if (agreementData.mySignatureData) {
            mySigImg.src = agreementData.mySignatureData;
            mySigImg.style.display = 'block';
            mySigCanvas.style.display = 'none';
            document.querySelector('#my-signature-area button').classList.add('hidden'); 
        } else {
            mySigImg.style.display = 'none';
            mySigCanvas.style.display = 'block';
            document.querySelector('#my-signature-area button').classList.remove('hidden');
        }

        // Client Signature
        const clientSigImg = document.getElementById('clientSignatureImage');
        const clientSigCanvas = document.getElementById('clientSignatureCanvas');

        if (agreementData.clientSignatureData) {
            clientSigImg.src = agreementData.clientSignatureData;
            clientSigImg.style.display = 'block';
            clientSigCanvas.style.display = 'none';
            document.querySelector('#client-signature-area button').classList.add('hidden'); 
            document.getElementById('client-signature-area').classList.add('border-green-600', 'border-4');
        } else {
            clientSigImg.style.display = 'none';
            clientSigCanvas.style.display = 'block';
            document.querySelector('#client-signature-area button').classList.remove('hidden');
            document.getElementById('client-signature-area').classList.remove('border-green-600', 'border-4');
        }
        
        // --- Action Buttons and Locking ---
        const mainActionBtn = document.getElementById('main-action-btn');
        const clientSignBtn = document.getElementById('client-sign-btn');
        const agreementInputsBlock = document.getElementById('agreement-inputs-block');
        const mainDocumentCard = document.querySelector('.main-document-card');

        // Reset classes
        mainActionBtn.classList.add('hidden');
        clientSignBtn.classList.add('hidden');
        agreementInputsBlock.classList.remove('client-mode', 'locked-mode');
        mainDocumentCard.classList.remove('border-green-600', 'border-red-600', 'border-4'); 

        const setActionBtnContent = (iconClass, text, bgColor, hoverColor) => {
            mainActionBtn.innerHTML = `<i class="fas ${iconClass} mr-2"></i> ${text}`;
            mainActionBtn.className = `bg-${bgColor} hover:bg-${hoverColor} text-white font-semibold py-3 px-6 rounded-lg text-sm sm:text-lg transition-colors duration-150 shadow-md`;
        };

        if (isClientMode) {
            agreementInputsBlock.classList.add('client-mode');
            if (agreementData.status === 'SignedByMe' && !agreementData.clientSignatureData) {
                clientSignBtn.classList.remove('hidden');
            } else if (agreementData.status === 'SignedByClient') {
                mainDocumentCard.classList.add('border-green-600', 'border-4');
                updateStatus('Contract is fully executed and complete.', 'bg-green-100 text-green-800', true);
            } else if (agreementData.status === 'Draft') {
                updateStatus('Waiting for Service Provider to sign the draft first.', 'bg-yellow-100 text-yellow-800', true);
            }
        } else {
            if (agreementData.status === 'SignedByClient') {
                agreementInputsBlock.classList.add('locked-mode');
                mainDocumentCard.classList.add('border-green-600', 'border-4');
                mainActionBtn.classList.add('hidden'); 
                updateStatus('Contract is fully executed and complete.', 'bg-green-100 text-green-800', true);
            } else if (agreementData.mySignatureData) {
                agreementInputsBlock.classList.add('locked-mode');
                mainDocumentCard.classList.add('border-red-600', 'border-4');
                mainActionBtn.classList.remove('hidden');
                
                // Content for "Re-Share"
                setActionBtnContent('fa-share-alt', 'Re-Share Link', 'green-600', 'green-700');
                updateStatus('Document is locked and waiting for client signature.', 'bg-red-100 text-red-800', true);

            } else {
                mainActionBtn.classList.remove('hidden');
                
                // Content for "Lock and Share"
                setActionBtnContent('fa-lock', 'Lock and Share', 'indigo-600', 'indigo-700');
                agreementData.isLocked = false; 
                updateStatus('Draft Mode: Fill details and sign to lock and share.', 'bg-blue-100 text-blue-800', true);
            }
        }
    }

    // --- SIGNATURE PAD LOGIC ---
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        
        const canvasA = document.getElementById('mySignatureCanvas');
        if (canvasA) {
            canvasA.width = canvasA.offsetWidth * ratio;
            canvasA.height = canvasA.offsetHeight * ratio;
            canvasA.getContext('2d').scale(ratio, ratio);
            if (mySignaturePad) mySignaturePad.clear();
        }
        
        const canvasB = document.getElementById('clientSignatureCanvas');
        if (canvasB) {
            canvasB.width = canvasB.offsetWidth * ratio;
            canvasB.height = canvasB.offsetHeight * ratio;
            canvasB.getContext('2d').scale(ratio, ratio);
            if (clientSignaturePad) clientSignaturePad.clear(); 
        }
    }
    
    window.clearMySignature = function() {
        if (isClientMode) return;
        
        if (mySignaturePad) mySignaturePad.clear();
        agreementData.mySignatureData = null;
        agreementData.status = 'Draft'; 
        agreementData.isLocked = false; 
        
        saveAgreementDraft();
        updateUIFromData();
        updateStatus('Signature cleared. Draft is now unlocked and editable.', 'bg-blue-100 text-blue-800', true);
    }
    
    window.clearClientSignature = function() {
        if (clientSignaturePad) clientSignaturePad.clear();
    }
    
    // 1. Service Provider Action: Sign, Lock, and Share (Triggers Modal)
    window.serviceProviderAction = async function() {
        if (isClientMode) return;
        if (!isConfigValid) {
             updateStatus('ERROR: Cannot proceed. Cloud sync is disabled.', 'bg-red-100 text-red-800');
             return;
        }
        
        const myName = agreementData.my_name ? agreementData.my_name.trim() : '';
        const clientName = agreementData.client_name ? agreementData.client_name.trim() : '';
        const clientEmail = agreementData.client_email ? agreementData.client_email.trim() : '';
        
        if (myName.length === 0 || myName === "Service Provider Name") {
            updateStatus('ERROR: "My Name (Service Provider)" field is required to lock and share.', 'bg-red-100 text-red-800');
            return;
        }
        if (clientName.length === 0 || clientName === "Client Name") {
            updateStatus('ERROR: "Client Name" field is required to lock and share.', 'bg-red-100 text-red-800');
            return;
        }
        
        // --- STEP 1: Capture Signature (if not already done) ---
        if (!agreementData.mySignatureData) {
            if (!mySignaturePad || mySignaturePad.isEmpty()) {
                updateStatus(`ERROR: You must draw your signature before you can lock and share the ${agreementData.document_type.toLowerCase()}.`, 'bg-red-100 text-red-800');
                return; 
            }
            
            const signatureBase64 = mySignaturePad.toDataURL('image/png');
            agreementData.mySignatureData = signatureBase64;
            agreementData.status = 'SignedByMe';
            updateStatus('Draft signing, locking, and saving...', 'bg-yellow-100 text-yellow-800');
        } else {
             updateStatus('Re-sharing locked document...', 'bg-yellow-100 text-yellow-800');
        }
        
        // Set lock state and save immediately
        agreementData.isLocked = true;
        await saveAgreementDraft();
        
        updateUIFromData();

        // Check if client signature is already received
        if (agreementData.status === 'SignedByClient') {
             updateStatus('Document is fully executed. No need to share.', 'bg-green-100 text-green-800');
             return;
        }
        
        // --- STEP 2: Open Email Modal ---
        const emailInput = document.getElementById('client_email_share');
        emailInput.value = clientEmail; // Pre-populate with current value
        validateEmail(clientEmail); // Validate pre-populated email
        document.getElementById('email-modal').classList.add('open');
    }


    // 2. Client Signs Contract
    window.clientSignAgreement = async function() {
        if (!isConfigValid || !db) {
            updateStatus('ERROR: Cloud service unavailable. Cannot sign.', 'bg-red-100 text-red-800');
            return;
        }
        
        if (!clientSignaturePad || clientSignaturePad.isEmpty()) {
            updateStatus('ERROR: Please draw your signature on the canvas to sign off.', 'bg-red-100 text-red-800');
            return;
        }

        if (agreementData.status !== 'SignedByMe') {
            updateStatus('Waiting for Service Provider to sign the draft first.', 'bg-yellow-100 text-yellow-800');
            return;
        }
        
        const signatureBase64 = clientSignaturePad.toDataURL('image/png');
        
        agreementData.clientSignatureData = signatureBase64;
        agreementData.status = 'SignedByClient';
        
        try {
             await updateDoc(getAgreementDocRef(agreementId), {
                 clientSignatureData: signatureBase64,
                 status: 'SignedByClient',
                 isLocked: true 
             });
             updateStatus('Final signature submitted! Document is complete and locked.', 'bg-green-100 text-green-800', true);
             updateUIFromData(); 
        } catch (error) {
            console.error("Error submitting client signature:", error);
            updateStatus('ERROR: Error submitting signature. Check connection.', 'bg-red-100 text-red-800');
        }
    }

    // --- UTILITY/UI LOGIC ---
    
    // NEW: Function to reset the app
    window.resetApp = function() {
        if (confirm("Are you sure you want to reset the application? This will discard your current local contract (if not saved) and start a fresh draft.")) {
            // Remove the agreementId query parameter and reload
            window.location.href = window.location.origin + window.location.pathname;
        }
    }

    window.handleDocumentTypeChange = function(selectElement) {
        if (isClientMode || agreementData.isLocked) return; 
        
        agreementData.document_type = selectElement.value;
        document.getElementById('input-block-title').textContent = `${agreementData.document_type} Details`;

        updateAgreementContent();
        saveAgreementDraft();
    }

    window.handleCurrencyChange = function(selectElement) {
        if (isClientMode || agreementData.isLocked) return; 

        agreementData.currency = selectElement.value;
        saveAgreementDraft();
        updateAgreementContent();
        updateInvoice();
    }

    window.handleInputChange = function(inputElement) {
        if (isClientMode || agreementData.isLocked) return; 
        
        const key = inputElement.getAttribute('data-model');
        let value = inputElement.value;
        
        document.querySelectorAll(`[data-model="${key}"]`).forEach(input => {
             if (input.id.endsWith('_main') && input !== inputElement) {
                 input.value = value;
             }
        });

        if (inputElement.type === 'number') {
            value = parseFloat(value) || 0;
        }

        agreementData[key] = value;
        
        if (key === 'my_name') {
            invoiceData.my_name = value;
            document.getElementById('my_name').value = value;
        }
        if (key === 'client_name') {
            invoiceData.client_invoice_name = value;
            document.getElementById('client_invoice_name').value = value;
        }
        // Sync client email
        if (key === 'client_email') {
            invoiceData.client_invoice_email = value;
            document.getElementById('client_invoice_email').value = value;
        }
        
        updateAgreementContent();
        saveAgreementDraft();
    }
    
    function isPlaceholder(value) {
        return value.startsWith('[') && value.endsWith(']');
    }

    function getPlaceholderText(key, value) {
        if (String(value).trim() !== "") {
            return value;
        }
        switch (key) {
            case 'my_name': return "[Your Name]";
            case 'client_name': return "[Client Name]";
            case 'project_title': return "[Project Title]";
            case 'project_scope': return "[Scope Summary]";
            case 'agreement_date': return "[Date]"; 
            default: return "[...]";
        }
    }
    
    function formatDateForDisplay(dateString) {
        if (!dateString || dateString.startsWith('[')) return getPlaceholderText('agreement_date', '');
        try {
            const date = new Date(dateString);
            if (isNaN(date)) return dateString;
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        } catch (e) {
            return dateString;
        }
    }

    function updateAgreementContent() {
        const currentCurrency = currencyMap[agreementData.currency] || currencyMap['INR'];
        const symbol = currentCurrency.symbol;
        
        const displayDate = formatDateForDisplay(agreementData.agreement_date);
        
        const docType = agreementData.document_type;
        const docTypeUpper = docType.toUpperCase();
        const docTypeLower = docType.toLowerCase();

        const dynamicElements = [
            { id: 'document_main_title', key: 'document_type', value: docTypeUpper },
            { id: 'doc_type_p1', key: 'document_type', value: docType },
            { id: 'doc_type_p1_short', key: 'document_type', value: docType },
            { id: 'doc_type_p2_lower', key: 'document_type', value: docTypeLower },
            { id: 'doc_type_p2', key: 'document_type', value: docType },
            { id: 'doc_type_p5', key: 'document_type', value: docType },
            { id: 'doc_type_p6', key: 'document_type', value: docType },

            { id: 'my_name_display_text', key: 'my_name', value: agreementData.my_name },
            { id: 'client_name_display_text', key: 'client_name', value: agreementData.client_name },
            { id: 'project_title_display_text', key: 'project_title', value: agreementData.project_title },
            { id: 'project_scope_display_text', key: 'project_scope', value: agreementData.project_scope },
            { id: 'my_name_display_signature', key: 'my_name', value: agreementData.my_name },
            { id: 'client_name_display_signature', key: 'client_name', value: agreementData.client_name },
            { id: 'total_fee_display', key: 'total_fee', value: agreementData.total_fee, isNumber: true }, 
            { id: 'currency_symbol_display', key: 'currency', value: symbol },
            { id: 'deposit_required_display', key: 'deposit_required', value: agreementData.deposit_required, isNumber: true },
            { id: 'agreement_date_display', key: 'agreement_date', value: displayDate, isDate: true },
        ];

        dynamicElements.forEach(item => {
            const element = document.getElementById(item.id);
            if (!element) return;
            
            let displayValue = item.value;
            let actualValue = item.value;

            if (item.isNumber) {
                if (item.id === 'deposit_required_display') {
                    displayValue = String(agreementData.deposit_required || 0);
                } else {
                    displayValue = formatNumber(agreementData.total_fee || 0, true);
                }
                actualValue = agreementData.total_fee;
            } else if (item.id === 'currency_symbol_display') {
                actualValue = agreementData.currency;
            } else if (item.key !== 'document_type') {
                displayValue = getPlaceholderText(item.key, actualValue);
            }
            
            element.textContent = displayValue;

            const isActualData = (item.key === 'document_type') || 
                                 (item.isDate && agreementData.agreement_date.trim() !== '') || 
                                 (String(actualValue).trim() !== "" && !isPlaceholder(displayValue));
                
            element.classList.remove('has-value');
            if (isActualData) {
                element.classList.add('has-value');
            }
        });
        
        document.getElementById('input-block-title').textContent = `${docType} Details`;
        document.querySelector('#share-modal h3').textContent = `Share ${docType}`;

        if (document.getElementById('invoice').classList.contains('active')) {
            updateInvoice();
        }
    }
    
    function formatNumber(amount, isContract = false) {
        const currentCurrency = currencyMap[agreementData.currency] || currencyMap['INR'];
        const options = {
            style: 'decimal', 
            minimumFractionDigits: isContract ? 0 : 2,
            maximumFractionDigits: isContract ? 0 : 2,
            useGrouping: true 
        };
        return new Intl.NumberFormat(currentCurrency.locale, options).format(amount).trim(); 
    }

    function formatAmountWithSymbol(amount) {
        const currentCurrency = currencyMap[agreementData.currency] || currencyMap['INR'];
        return `${currentCurrency.symbol}${formatNumber(amount, false)}`; 
    }
    
    window.formatCurrency = function(amount) {
        return formatAmountWithSymbol(amount);
    }
    
    window.updateInvoice = function(key, value) {
        if (key) {
            invoiceData[key] = value;
        }

        document.getElementById('my_name').value = invoiceData.my_name;
        document.getElementById('my_address').value = invoiceData.my_address;
        document.getElementById('my_email').value = invoiceData.my_email;
        document.getElementById('invoice_id').value = invoiceData.invoice_id;
        document.getElementById('invoice_date').value = invoiceData.invoice_date;
        document.getElementById('client_invoice_name').value = invoiceData.client_invoice_name;
        document.getElementById('client_invoice_address').value = invoiceData.client_invoice_address;
        document.getElementById('client_invoice_email').value = invoiceData.client_invoice_email;
        document.getElementById('payment_notes').value = invoiceData.payment_notes;
        
        const currentCurrency = currencyMap[agreementData.currency];
        
        document.querySelector('#invoice table thead th:nth-child(3)').textContent = `Rate (${currentCurrency.symbol})`;
        document.querySelector('#invoice table thead th:nth-child(4)').textContent = `Amount (${currentCurrency.symbol})`;

        const tbody = document.getElementById('line-items-body');
        tbody.innerHTML = '';
        
        invoiceData.items.forEach((item, index) => {
            const amount = item.qty * item.rate;
            item.amount = amount;
            
            const row = `
                <tr>
                    <td>
                        <input type="text" value="${item.description}" 
                            oninput="updateItem(${index}, 'description', this.value)" class="invoice-input">
                    </td>
                    <td>
                        <input type="number" value="${item.qty}" 
                            oninput="updateItem(${index}, 'qty', parseFloat(this.value) || 0)" class="invoice-input text-center">
                    </td>
                    <td>
                        <input type="number" value="${item.rate}" 
                            oninput="updateItem(${index}, 'rate', parseFloat(this.value) || 0)" class="invoice-input text-right">
                    </td>
                    <td class="text-right font-mono">${formatCurrency(amount)}</td>
                    <td class="no-print">
                        <button onclick="deleteItemRow(${index})" class="text-red-500 hover:text-red-700 p-1">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        calculateTotals();
    }
    
    window.updateItem = function(index, key, value) {
        if (invoiceData.items[index]) {
            invoiceData.items[index][key] = value;
            updateInvoice();
        }
    }
    
    window.addItemRow = function() {
        invoiceData.items.push({ description: '', qty: 1, rate: 0, amount: 0 });
        updateInvoice();
    }
    
    window.deleteItemRow = function(index) {
        invoiceData.items.splice(index, 1);
        updateInvoice();
    }

    window.calculateTotals = function() {
        const subtotal = invoiceData.items.reduce((sum, item) => sum + (item.qty * item.rate), 0);
        const taxRate = parseFloat(document.getElementById('tax_rate').value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const totalDue = subtotal + taxAmount;

        document.getElementById('subtotal_display').textContent = formatCurrency(subtotal);
        document.getElementById('tax_amount_display').textContent = formatCurrency(taxAmount);
        document.getElementById('total_due_display').textContent = formatCurrency(totalDue);
    }
    
    window.showShareModal = function() {
        // This is now the manual link modal
        const shareLink = `${window.location.origin}${window.location.pathname}?agreementId=${agreementId}`;
        document.getElementById('share-link-input').value = shareLink;
        document.getElementById('share-modal').classList.add('open');
    }
    
    // NEW: Email validation for the modal
    window.validateEmail = function(email) {
        const emailInput = document.getElementById('client_email_share');
        const errorMsg = document.getElementById('email-error');
        const sendBtn = document.getElementById('send-email-btn');
        
        // Basic regex for email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (emailRegex.test(email)) {
            errorMsg.classList.add('hidden');
            sendBtn.disabled = false;
        } else {
            errorMsg.classList.remove('hidden');
            sendBtn.disabled = true;
        }
    }
    
    // NEW: Action when "Send Link" is clicked
    window.sendEmailOrShowLink = async function() {
        const emailInput = document.getElementById('client_email_share');
        const email = emailInput.value.trim();

        if (email === "") {
            document.getElementById('email-error').textContent = "Email is required to share the contract.";
            document.getElementById('email-error').classList.remove('hidden');
            return;
        }

        if (document.getElementById('send-email-btn').disabled) {
            return; // Should be handled by validateEmail, but double check
        }

        // 1. Update the contract data with the new email, in case it was changed in the modal
        agreementData.client_email = email;
        document.getElementById('client_email_main').value = email; 
        updateInvoice('client_invoice_email', email); // Also update invoice data
        
        // 2. Save the final document (already SignedByMe and Locked)
        await saveAgreementDraft();
        
        // 3. Close the email modal
        closeModal('email-modal');
        
        // 4. Simulate email sending and show the success message/link
        updateStatus(`SUCCESS! The contract link has been 'emailed' to ${email}.`, 'bg-green-100 text-green-800');
        showShareModal(); // Open the manual link modal
    }

    window.closeModal = function(modalId) {
        if (modalId) {
             document.getElementById(modalId).classList.remove('open');
        } else {
             document.getElementById('share-modal').classList.remove('open');
             document.getElementById('email-modal').classList.remove('open'); // Close the new modal too
             document.getElementById('error-modal').classList.remove('open');
        }
    }
    
    window.copyShareLink = function() {
        const linkInput = document.getElementById('share-link-input');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999); 
        document.execCommand('copy');
        updateStatus('Share link copied to clipboard! You can now paste it into your email.', 'bg-indigo-100 text-indigo-800');
        closeModal();
    }
    
    // --- PDF / PRINT LOGIC ---
    
    window.printDocument = async function() {
        document.getElementById('loading-indicator').classList.remove('hidden');

        const agreementArea = document.getElementById('agreement');
        const invoiceArea = document.getElementById('invoice');
        const elementToCapture = agreementArea.classList.contains('active') ? agreementArea : invoiceArea;
        
        const mySigCanvas = document.getElementById('mySignatureCanvas');
        const clientSigCanvas = document.getElementById('clientSignatureCanvas');
        
        document.querySelectorAll('.no-print').forEach(el => el.classList.add('hidden-for-pdf'));
        
        if (agreementData.mySignatureData) {
            document.getElementById('mySignatureImage').style.display = 'block';
            mySigCanvas.style.display = 'none';
        }
        if (agreementData.clientSignatureData) {
            document.getElementById('clientSignatureImage').style.display = 'block';
            clientSigCanvas.style.display = 'none';
        }

        const canvas = await html2canvas(elementToCapture, { 
            scale: 4, 
            useCORS: true,
            ignoreElements: (element) => element.classList.contains('hidden-for-pdf') 
        });

        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const pdfWidth = pdf.internal.pageSize.getWidth(); 
        const pdfHeight = pdf.internal.pageSize.getHeight(); 

        const imgWidth = pdfWidth;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;

        const scaleFactor = Math.min(1, pdfHeight / imgHeight); 
        
        const finalImgWidth = imgWidth * scaleFactor;
        const finalImgHeight = imgHeight * scaleFactor;
        
        const xOffset = (pdfWidth - finalImgWidth) / 2;
        const yOffset = (pdfHeight - finalImgHeight) / 2;

        pdf.addImage(canvas.toDataURL('image/jpeg', 0.8), 'JPEG', xOffset, yOffset, finalImgWidth, finalImgHeight);

        document.querySelectorAll('.hidden-for-pdf').forEach(el => el.classList.remove('hidden-for-pdf'));
        if (agreementData.mySignatureData) {
             document.getElementById('mySignatureImage').style.display = 'none';
             mySigCanvas.style.display = 'block';
        }
        if (agreementData.clientSignatureData) {
             document.getElementById('clientSignatureImage').style.display = 'none';
             clientSigCanvas.style.display = 'block';
        }

        const clientFileName = agreementData.client_name.replace(/[^a-z0-9]/gi, '_') || 'Client';
        const docTitle = agreementData.project_title.replace(/[^a-z0-9]/gi, '_') || 'Contract';
        const filename = elementToCapture.id === 'agreement' ? `${clientFileName}_${agreementData.document_type}_${docTitle}_${agreementData.status}.pdf` : `${clientFileName}_Invoice.pdf`;
        
        pdf.save(filename);
        document.getElementById('loading-indicator').classList.add('hidden');
    }
    
    // UPDATED TAB SWITCHER
    window.switchTab = function(tabId, button) {
        // Reset ALL buttons to default gray state
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('tab-active', 'tab-active-bg', 'text-white', 'text-gray-700');
            btn.classList.add('text-gray-500'); // Default inactive text
        });
        
        // Set Active Button
        button.classList.remove('text-gray-500');
        button.classList.add('tab-active', 'tab-active-bg', 'text-white');
        
        document.querySelectorAll('.content-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        
        const activePanel = document.getElementById(tabId);
        if (activePanel) {
            activePanel.classList.add('active');
        }

        const inputsBlock = document.getElementById('agreement-inputs-block');
        if (inputsBlock) {
            if (tabId === 'agreement') {
                inputsBlock.classList.remove('hidden');
                resizeCanvas();
            } else {
                inputsBlock.classList.add('hidden');
            }
        }
        
        if (tabId === 'agreement') {
            updateAgreementContent();
        } else if (tabId === 'invoice') {
            updateInvoice();
        }
    }


    document.addEventListener('DOMContentLoaded', () => {
        const myCanvas = document.getElementById('mySignatureCanvas');
        if (myCanvas) {
            mySignaturePad = new SignaturePad(myCanvas, {
                backgroundColor: 'rgb(245, 245, 245)', 
                penColor: 'rgb(0, 0, 0)'
            });
        }
        
        const clientCanvas = document.getElementById('clientSignatureCanvas');
        if (clientCanvas) {
            clientSignaturePad = new SignaturePad(clientCanvas, {
                backgroundColor: 'rgb(245, 245, 245)', 
                penColor: 'rgb(0, 0, 0)'
            });
        }
        
        resizeCanvas(); 
        window.addEventListener('resize', resizeCanvas);
        
        initFirebase();
        
        invoiceData.my_name = agreementData.my_name;
        invoiceData.client_invoice_name = agreementData.client_name;
        document.getElementById('invoice_date').value = invoiceData.invoice_date;
        
        updateInvoice();
    });
</script>

</body>
</html>